# 儿童发育行为评估Flutter应用 - 技术设计文档

## 1. 技术栈选择

### 1.1 核心技术
- **Flutter**: 跨平台UI框架
- **Dart**: 编程语言
- **SQLite**: 本地数据存储
- **Provider/Riverpod**: 状态管理
- **GetX**: 路由管理

### 1.2 开发环境
- **Flutter SDK**: 3.16.0+
- **Dart**: 3.2.0+
- **IDE**: Android Studio / VS Code
- **模拟器**: Android Emulator / iOS Simulator

### 1.3 项目结构
```
lib/
├── main.dart                 # 应用入口
├── app/
│   ├── app.dart             # 应用配置
│   └── routes.dart          # 路由配置
├── core/
│   ├── constants/           # 常量定义
│   ├── utils/              # 工具函数
│   └── services/           # 核心服务
├── data/
│   ├── models/             # 数据模型
│   ├── repositories/       # 数据仓库
│   └── datasources/        # 数据源
├── presentation/
│   ├── pages/             # 页面组件
│   ├── widgets/           # 通用组件
│   └── providers/         # 状态管理
└── assets/
    ├── images/            # 图片资源
    └── data/             # 数据文件
```

## 1. 数据结构设计

### 1.1 核心数据模型

#### 1.1.1 宝宝信息 (Baby)
```json
{
  "id": "string",           // 唯一标识
  "name": "string",         // 宝宝姓名
  "birthDate": "string",    // 出生日期 (YYYY-MM-DD)
  "gender": "string",       // 性别 ("male" | "female")
  "avatar": "string",       // 头像路径 (可选)
  "createdAt": "string",    // 创建时间
  "updatedAt": "string"     // 更新时间
}
```

#### 1.1.2 测试记录 (TestRecord)
```json
{
  "id": "string",           // 唯一标识
  "babyId": "string",       // 宝宝ID
  "testDate": "string",     // 测试日期
  "ageInMonths": "number",  // 测试时月龄 (精确到小数点后一位)
  "mainTestAge": "number",  // 主测月龄
  "results": {              // 测试结果
    "motor": {              // 大运动能区
      "score": "number",    // 得分
      "mentalAge": "number" // 智龄
    },
    "fineMotor": {          // 精细动作能区
      "score": "number",
      "mentalAge": "number"
    },
    "language": {           // 语言能区
      "score": "number",
      "mentalAge": "number"
    },
    "adaptive": {           // 适应能力能区
      "score": "number",
      "mentalAge": "number"
    },
    "social": {             // 社会行为能区
      "score": "number",
      "mentalAge": "number"
    }
  },
  "totalMentalAge": "number", // 总体智龄
  "developmentQuotient": "number", // 发育商
  "level": "string",        // 发育水平 ("excellent" | "good" | "average" | "low" | "disability")
  "status": "string"        // 测试状态 ("in_progress" | "completed")
}
```

#### 1.1.3 测试项目 (TestItem)
```json
{
  "id": "string",           // 唯一标识
  "ageGroup": "number",     // 月龄组 (如: 12, 15, 18, 21, 24...)
  "area": "string",         // 能区 ("motor" | "fineMotor" | "language" | "adaptive" | "social")
  "order": "number",        // 项目顺序
  "title": "string",        // 项目标题
  "requirement": "string",  // 测试要求
  "method": "string",       // 操作方法
  "passStandard": "string", // 通过标准
  "score": "number",        // 单项得分 (根据月龄组不同)
  "imagePath": "string"     // 配图路径 (可选)
}
```

#### 1.1.4 测试项目结果 (TestItemResult)
```json
{
  "id": "string",           // 唯一标识
  "testRecordId": "string", // 测试记录ID
  "itemId": "string",       // 测试项目ID
  "result": "boolean",      // 通过/不通过
  "note": "string",         // 备注 (可选)
  "testTime": "string"      // 测试时间
}
```

### 1.2 月龄组得分规则

根据国家标准，不同月龄组的得分规则：

- **1-12月龄**: 每个能区1.0分，单个项目0.5-1.0分
- **15-36月龄**: 每个能区3.0分，单个项目1.5-3.0分  
- **42-84月龄**: 每个能区6.0分，单个项目3.0-6.0分

### 1.3 发育商计算逻辑

#### 1.3.1 智龄计算
1. **各能区智龄计算**:
   - 将连续通过的测查项目分数相加
   - 连续两个月龄通过则不再往前继续测，默认前面的全部通过
   - 不通过的项目不计算分数

2. **总体智龄计算**:
   ```
   总体智龄 = (大运动智龄 + 精细动作智龄 + 语言智龄 + 适应能力智龄 + 社会行为智龄) ÷ 5
   ```

#### 1.3.2 发育商计算
```
发育商 = (智龄 ÷ 实际月龄) × 100
```

#### 1.3.3 发育水平评级
- **优秀**: DQ > 130
- **良好**: DQ 110-129
- **中等**: DQ 80-109
- **临界偏低**: DQ 70-79
- **智力发育障碍**: DQ < 70

## 2. 数据提取脚本

### 2.1 脚本功能
- 解析Excel文件中的测试项目数据
- 提取操作方法和通过要求
- 生成标准化的JSON数据文件
- 验证数据完整性

### 2.2 输出文件
- `data/test_items.json`: 所有测试项目数据
- `data/age_groups.json`: 月龄组配置
- `data/calculation_rules.json`: 计算规则配置

## 3. 数据库设计

### 3.1 SQLite表结构

#### 3.1.1 babies表
```sql
CREATE TABLE babies (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    birth_date TEXT NOT NULL,
    gender TEXT NOT NULL,
    avatar TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

#### 3.1.2 test_records表
```sql
CREATE TABLE test_records (
    id TEXT PRIMARY KEY,
    baby_id TEXT NOT NULL,
    test_date TEXT NOT NULL,
    age_in_months REAL NOT NULL,
    main_test_age INTEGER NOT NULL,
    total_mental_age REAL,
    development_quotient REAL,
    level TEXT,
    status TEXT NOT NULL,
    created_at TEXT NOT NULL,
    FOREIGN KEY (baby_id) REFERENCES babies (id)
);
```

#### 3.1.3 test_item_results表
```sql
CREATE TABLE test_item_results (
    id TEXT PRIMARY KEY,
    test_record_id TEXT NOT NULL,
    item_id TEXT NOT NULL,
    result INTEGER NOT NULL, -- 0: 不通过, 1: 通过
    note TEXT,
    test_time TEXT NOT NULL,
    FOREIGN KEY (test_record_id) REFERENCES test_records (id)
);
```

## 4. 核心算法

### 4.1 月龄计算
```dart
double calculateAgeInMonths(DateTime birthDate, DateTime testDate) {
  int years = testDate.year - birthDate.year;
  int months = testDate.month - birthDate.month;
  int days = testDate.day - birthDate.day;
  
  double totalMonths = years * 12 + months + days / 30.0;
  return double.parse(totalMonths.toStringAsFixed(1));
}
```

### 4.2 主测月龄确定
```dart
int determineMainTestAge(double ageInMonths) {
  // 根据实际月龄确定最接近的月龄组
  List<int> ageGroups = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 18, 21, 24, 27, 30, 33, 36, 42, 48, 54, 60, 66, 72, 78, 84];
  
  int mainTestAge = ageGroups[0];
  double minDiff = (ageInMonths - ageGroups[0]).abs();
  
  for (int age in ageGroups) {
    double diff = (ageInMonths - age).abs();
    if (diff < minDiff) {
      minDiff = diff;
      mainTestAge = age;
    }
  }
  
  return mainTestAge;
}
```

### 4.3 智龄计算
```dart
double calculateMentalAge(List<TestItemResult> results, String area) {
  double totalScore = 0.0;
  
  // 按月龄组排序，从高到低
  results.sort((a, b) => b.item.ageGroup.compareTo(a.item.ageGroup));
  
  // 计算连续通过的分数
  for (TestItemResult result in results) {
    if (result.item.area == area && result.result) {
      totalScore += result.item.score;
    } else if (result.item.area == area && !result.result) {
      break; // 遇到不通过的项目停止计算
    }
  }
  
  return totalScore;
}
```

### 4.4 发育商计算
```dart
double calculateDevelopmentQuotient(double totalMentalAge, double actualAgeInMonths) {
  if (actualAgeInMonths == 0) return 0.0;
  return (totalMentalAge / actualAgeInMonths) * 100;
}
```

## 5. 测试流程设计

### 5.1 测试启动流程
1. 选择宝宝
2. 计算当前月龄
3. 确定主测月龄
4. 生成测试项目列表
5. 开始测试

### 5.2 测试进行流程
1. 显示当前测试项目
2. 记录通过/不通过结果
3. 自动计算进度
4. 智能切换能区
5. 完成所有项目后计算结果

### 5.3 结果计算流程
1. 计算各能区智龄
2. 计算总体智龄
3. 计算发育商
4. 确定发育水平
5. 生成测试报告

## 6. 数据验证规则

### 6.1 输入验证
- 宝宝姓名不能为空
- 出生日期必须在合理范围内
- 测试日期不能早于出生日期
- 月龄必须在0-84个月范围内

### 6.2 计算验证
- 智龄不能为负数
- 发育商必须在合理范围内 (0-200)
- 各能区得分不能超过最大值

### 6.3 数据完整性
- 测试记录必须包含所有能区的数据
- 项目结果必须完整记录
- 计算结果必须一致 